var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},e={},s={},i=t.parcelRequire86ed;function n(t,e,s,i,n,o="rgb(0, 0, 0)",h=!1){t.beginPath(),t.font=n+"px Arial",t.textAlign="center",!1===h&&(t.fillStyle=o,t.fillText(e,s,i)),!0===h&&(t.lineWidth=n/25,t.strokeStyle=o,t.strokeText(e,s,i))}null==i&&((i=function(t){if(t in e)return e[t].exports;if(t in s){var i=s[t];delete s[t];var n={id:t,exports:{}};return e[t]=n,i.call(n.exports,n,n.exports),n.exports}var o=new Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(t,e){s[t]=e},t.parcelRequire86ed=i);class o{constructor(t,e){this.x=t,this.y=e}normalize(){let t=Math.sqrt(this.x**2+this.y**2);return new o(this.x/t,this.y/t)}angleFrom(t=new o(0,0)){return Math.atan2(this.y-t.x,this.x-t.y)}angleTo(t){return Math.atan2(t.y-this.y,t.x-this.x)}length(){return Math.sqrt(this.x**2+this.y**2)}distanceTo(t){return Math.sqrt((t.x-this.x)**2+(t.y-this.y)**2)}worldToView(t){return new o((this.x-t.x)/t.w,(this.y-t.y)/t.h)}screenToPixel(t){return new o(l(this.x,0,1,0,t.width),l(this.y,0,1,0,t.height))}worldToPixel(t,e){return this.worldToView(t).screenToPixel(e)}interpolate(t,e=.5){return new o(this.x*(1-e)+t.x*e,this.y*(1-e)+t.y*e)}minus(t){return new o(this.x-t.x,this.y-t.y)}plus(t){return new o(this.x+t.x,this.y+t.y)}times(t){return"number"==typeof t?new o(this.x*t,this.y*t):new o(this.x*t.x,this.y*t.y)}equals(t){return t.x===this.x&&t.y===this.y}copy(){return new o(this.x,this.y)}}class h{constructor(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}NW(){return new o(this.x,this.y)}NE(){return new o(this.x+this.w,this.y)}SW(){return new o(this.x,this.y+this.h)}SE(){return new o(this.x+this.w,this.y+this.h)}middle(){return new o(this.x+this.w/2,this.y+this.h/2)}setMid(t){this.x=t.x-this.w/2,this.y=t.y-this.h/2}checkPos(t){return t.x>this.x&&t.x<this.x+this.w&&t.y>this.y&&t.y<this.y+this.h}worldToView(t){return new h((this.x-t.x)/t.w,(this.y-t.y)/t.h,this.w/t.w,this.h/t.h)}screenToPixel(t){return new h(this.x*t.width,this.y*t.height,this.w*t.width,this.h*t.height)}worldToPixel(t,e){return this.worldToView(t).screenToPixel(e)}}function l(t,e,s,i,n,o=!1){var h=(t-e)/(s-e)*(n-i)+i;return o?a(h,i,n):h}function a(t,e,s){return Math.min(Math.max(t,e),s)}function r(t,e=0){let s=10**e;return Math.round(t*s)/s}function c(t,e=.01){const s=Math.min(t.p1.x,t.p2.x)-e,i=Math.min(t.p1.y,t.p2.y)-e,n=Math.max(t.p1.x,t.p2.x)+e,o=Math.max(t.p1.y,t.p2.y)+e;return new h(s,i,n-s,o-i)}function d(t,e,s){let i=[];for(let s of t){c(s).checkPos(e)&&i.push(s)}for(let t of i){const i=t.p1.angleTo(t.p2),n=t.p1.angleTo(e)-i,o=t.p1.angleTo(s)-i;if(Math.sign(n)!==Math.sign(o))if(Math.abs(n)<.2){if(t.p1.distanceTo(t.p2)>t.p1.distanceTo(e))return t;console.log("passed line far")}else console.log("passed line close")}}function g(t,e=15,s=.1){let i=[];console.log(`map seed ${t}`);for(let t=0;t<e**2*s;t++){let t=1,s=1,n=t+1,h=s+1;for(;t==n&&s==h||n>e||n<0||h>e||h<0;)n=t+1,h=s+1;i.push({p1:new o(t/e,s/e),p2:new o(n/e,h/e)})}return i}var p=i("cMFB8");class u{constructor(t,e){this.pos=new o(0,0),this.lastPos=new o(0,0),this.speed=0,this.angle=0,this.inputX=0,this.inputY=0,this.TURN=.8,this.ACCEL=.015,this.SWING_ACCEL=.01,this.SWING_TURN=0,this.MAX_SPEED=5,this.DRAG=.12,this.WALL_BOUNCE=.6,this.swingPos=new o(0,0),this.recentlySwung=[],this.swingDist=0,this.swinging=!1,this.wasSwinging=!1,this.wasNetSwinging=!1,this.SWING_COOLDOWN=1.5,this.bulletPos=new o(0,0),this.bulletAngle=0,this.bulletAge=0,this.bulletAlive=!1,this.BULLET_SPEED=.1,this.BULLET_LIFETIME=3,this.lastBulletPos=new o(0,0),this.onCreateExplosion=t=>{},this.lookAngle=0,this.health=100,this.ping=0,this.id=t,e&&(this.onCreateExplosion=e)}static fromPlayerData(t,e){if("id"in t)return Object.assign(new u(t.id,e),t);throw"tried to create a player without id"}static newRandom(t,e){let s=new u(t,e);return s.pos.x=Math.random(),s.pos.y=Math.random(),s}render(t){const e=this.pos.worldToPixel(t,p.canvas);if(this.swinging){const s=this.swingPos.worldToPixel(t,p.canvas);p.ctx.beginPath(),p.ctx.strokeStyle="rgba(0, 0, 0, 0.9)",p.ctx.lineWidth=4,p.ctx.moveTo(e.x,e.y),p.ctx.lineTo(s.x,s.y),p.ctx.stroke()}if(p.ctx.beginPath(),p.ctx.strokeStyle="gray",p.ctx.lineWidth=6,p.ctx.arc(e.x,e.y,20,0,2*Math.PI),p.ctx.stroke(),p.ctx.beginPath(),p.ctx.strokeStyle="grey",p.ctx.lineWidth=6,p.ctx.moveTo(e.x,e.y),p.ctx.lineTo(e.x+30*Math.cos(this.angle),e.y+30*Math.sin(this.angle)),p.ctx.stroke(),this.bulletAlive){const e=this.bulletPos.worldToPixel(t,p.canvas);p.ctx.beginPath(),p.ctx.fillStyle="black",p.ctx.arc(e.x,e.y,10,0,2*Math.PI),p.ctx.fill()}n(p.ctx,`id: ${this.id}  ${r(this.ping,2)}ms`,e.x,e.y-30,10)}update(t,e){this.lastPos=new o(this.pos.x,this.pos.y);const s=t/1e3;if(this.swinging){this.swingDist+=this.inputX*s*this.SWING_TURN,this.speed+=this.inputY*s*this.SWING_ACCEL;const t=this.pos.minus(this.swingPos),e=new o(t.x+s*Math.cos(this.angle)*this.speed,t.y+s*Math.sin(this.angle)*this.speed).normalize().times(this.swingDist),i=e.minus(t);0==this.wasSwinging&&(this.speed=i.length()/s),this.angle=Math.atan2(i.y,i.x),this.pos=this.swingPos.plus(e),this.wasSwinging=!0}else{for(let t of this.recentlySwung)t.t-=s;this.recentlySwung=this.recentlySwung.filter((t=>t.t>0)),this.speed+=this.inputY*s*this.ACCEL,this.angle+=this.inputX*s*this.TURN,this.speed*=1-this.DRAG*s,this.pos.x+=s*Math.cos(this.angle)*this.speed,this.pos.y+=s*Math.sin(this.angle)*this.speed,this.wasSwinging=!1}const i=d(e,this.pos,this.lastPos);if(i){this.pos=this.lastPos,this.speed*=this.WALL_BOUNCE;const t=i.p1.angleTo(i.p2),e=i.p1.angleTo(this.pos)-t,s=t-Math.sign(e)*Math.PI/2,n=s-(this.angle-Math.PI);console.log(this.angle,s),this.angle=s+n,console.log("hit line")}if(this.bulletAlive){this.bulletPos.x+=Math.cos(this.bulletAngle)*this.BULLET_SPEED*s,this.bulletPos.y+=Math.sin(this.bulletAngle)*this.BULLET_SPEED*s,this.bulletAge+=s,this.bulletAge>this.BULLET_LIFETIME&&(this.bulletAlive=!1);d(e,this.bulletPos,this.lastBulletPos)&&(this.bulletAlive=!1,this.onCreateExplosion(this.bulletPos)),this.lastBulletPos=this.bulletPos.copy()}}networkUpdate(t){t.id===this.id&&(this.pos.x=t.x,this.pos.y=t.y,this.speed=t.speed,this.angle=t.angle,this.lookAngle=t.lookAngle,this.ping=t.ping,t.swingPos?(this.swingPos=new o(t.swingPos.x,t.swingPos.y),this.swinging=!0,this.swingDist=this.pos.distanceTo(this.swingPos),this.wasNetSwinging=!0):(this.wasNetSwinging&&(console.log("added to recently swung"),this.recentlySwung.push({p:this.swingPos,t:this.SWING_COOLDOWN})),this.swinging=!1,this.wasNetSwinging=!1),t.bulletPos&&t.bulletAngle&&t.bulletAge?([this.bulletPos.x,this.bulletPos.y]=[t.bulletPos.x,t.bulletPos.y],this.bulletAngle=t.bulletAngle,this.bulletAge=t.bulletAge,this.bulletAlive=!0):this.bulletAlive&&(this.bulletAlive=!1,this.onCreateExplosion(this.bulletPos)))}toData(){let t={id:this.id,x:this.pos.x,y:this.pos.y,angle:this.angle,speed:this.speed,lookAngle:this.lookAngle,ping:this.ping};return this.swinging&&(t.swingPos=this.swingPos),this.bulletAlive&&(t.bulletAge=this.bulletAge,t.bulletAngle=this.bulletAngle,t.bulletPos=this.bulletPos),t}setLookAngle(t){this.lookAngle=t}takeInput(t,e){if(this.inputX=a(t.data.inputX,-1,1),this.inputY=a(t.data.inputY,-1,1),this.lookAngle=t.data.lookAngle,t.data.swinging){if(!this.swinging){console.log("set swinging");const t=this.findClosestHandle(e);this.swingPos=t.pos,this.swingDist=t.dist,this.swinging=!0}}else this.swinging&&this.recentlySwung.push({p:this.swingPos,t:this.SWING_COOLDOWN}),this.swinging=!1;t.data.shooting&&!1===this.bulletAlive&&(this.bulletAlive=!0,this.bulletPos=this.pos.copy(),this.bulletAge=0,this.bulletAngle=this.angle),t.data.detonating&&this.bulletAlive&&(this.bulletAlive=!1,this.onCreateExplosion(this.bulletPos))}findClosestHandle(t){let e=9999,s=new o(0,0);for(let i of t){const t=(i.p1.x-this.pos.x)**2+(i.p1.y-this.pos.y)**2;t<e&&(this.recentlySwung.some((t=>t.p.equals(i.p1)))||(e=t,s=i.p1));const n=(i.p2.x-this.pos.x)**2+(i.p2.y-this.pos.y)**2;n<e&&(this.recentlySwung.some((t=>t.p.equals(i.p2)))||(e=n,s=i.p2))}return{pos:s,dist:Math.sqrt(e)}}impulseFrom(t,e,s=.1,i=100){const n=t.minus(this.pos),h=l(n.length(),0,e,1,0);if(n.length()<e){let t=this.pos.plus(n.normalize().times(-1*h*s));t=t.plus(new o(Math.cos(this.angle)*this.speed,Math.sin(this.angle)*this.speed)),this.angle=this.pos.angleTo(t),this.speed=this.pos.distanceTo(t)}}}p=i("cMFB8");const w=new class{constructor(){this.x=0,this.y=0,this.left=!1,this.hasLeft=!1,this.right=!1,this.hasRight=!1,this.middle=!1,this.hasMiddle=!1,document.addEventListener("mousemove",(t=>{const e=p.canvas.getBoundingClientRect();this.x=t.clientX-e.left,this.y=t.clientY-e.top}),!1),document.addEventListener("mousedown",(t=>{switch(t.button){case 0:this.left=!0,this.hasLeft=!0;break;case 1:this.middle=!0,this.hasMiddle=!0;break;case 2:this.right=!0,this.hasRight=!0}console.log(this)})),document.addEventListener("mouseup",(t=>{switch(t.button){case 0:this.left=!1;break;case 1:this.middle=!1;break;case 2:this.right=!1}}))}hasClicked(t){return!!this[t]&&(this[t]=!1,!0)}};const y=new class{constructor(){this.keys={},this.pressedAnyKey=!1,document.addEventListener("keydown",(t=>{this.keys[t.code]=!0,this.pressedAnyKey=!0})),document.addEventListener("keyup",(t=>{this.keys[t.code]=!1}))}checkKey(t){return t in this.keys&&this.keys[t]}};class x{constructor(t,e,s,i,n){this.ready=!1,this.peerConnection=new RTCPeerConnection,this.id=t,this.localId=e,this.wsSender=s,this.onPeerMsg=i,this.onPeerReady=n,this.peerConnection.ondatachannel=t=>{this.dataChannel=t.channel,console.log("on data channel called"),this.setDatachannelCallbacks()},this.peerConnection.onicecandidate=t=>{if(t.candidate){let e={src:this.localId,dst:this.id,messageType:"ice-candidate",candidate:t.candidate};console.log("ice candidate generated and send"),this.wsSender(e)}else console.log("All ICE candidates sent!")}}setDatachannelCallbacks(){console.log(`set data channel callbacks ${this.dataChannel}`),this.dataChannel?(this.dataChannel.onopen=t=>{console.log("All set!"),this.ready=!0,this.onPeerReady(this.id)},this.dataChannel.onclose=t=>{console.log("P1: Hey, my data channel was closed!")},this.dataChannel.onmessage=t=>{this.onPeerMsg(JSON.parse(t.data),this.id)}):console.log("data channel didnt exist to set callbacks")}sendString(t){this.ready?this.dataChannel.send(t):(console.log("tried to send before ready"),console.log(this))}sendObject(t){this.sendString(JSON.stringify(t))}createDataOffer(){this.peerConnection.createOffer().then((t=>{this.peerConnection.setLocalDescription(t);let e={src:this.localId,dst:this.id,messageType:"data-offer",sessionDescription:t};console.log(t),this.wsSender(e),this.setDatachannelCallbacks()})),this.dataChannel=this.peerConnection.createDataChannel("myFirstDataChannel")}handleDataOffer(t){this.peerConnection.setRemoteDescription(t.sessionDescription),this.peerConnection.createAnswer().then((e=>{console.log("created answer"),this.peerConnection.setLocalDescription(e);let s={src:t.dst,dst:t.src,messageType:"data-answer",sessionDescription:e};this.wsSender(s)}))}handleDataAnswer(t){this.peerConnection.setRemoteDescription(t.sessionDescription)}handleIceCandidate(t){let e=new RTCIceCandidate(t.candidate);this.peerConnection.addIceCandidate(e).then((()=>{console.log("Ice Candidate successfully added to peerconnection")}),(t=>{console.log("PR 1: Oh no! We failed to add the candidate"),console.log("Here's the error:",t)}))}}Date.now();const m=new class{constructor(){this.peers=[],this.gamesList=[],this.onPeerMsg=t=>{},this.onNewPeer=t=>{},this.onServerOpen=()=>{},this.visable=!1,this.hosting=!1,this.connected=!1,this.socket=new WebSocket("wss://multiplayer-backend.olikat.repl.co"),this.socket.onopen=t=>{console.log("server connection opened"),this.onServerOpen(),this.wsSend("get-id"),setInterval((()=>{this.wsSend("ping"),performance.now()}),2e3)},this.socket.onmessage=t=>{try{var e=JSON.parse(t.data)}catch{return void console.log("recived non-json from server")}"give-id"==e.type&&(this.id=e.data,console.log(`got id: ${this.id}`),this.wsSend("list-games")),"games-list"==e.type&&(this.gamesList=e.data,console.log(`got games list: ${this.gamesList}`),this.onGameList(this.gamesList)),e.type,"rtc-signal"==e.type&&this.signalHandler(e.data)},this.socket.onclose=function(t){t.wasClean?console.log(`[close] WS Connection closed cleanly, code=${t.code} reason=${t.reason}`):console.log("[close] WS Connection died")},this.socket.onerror=function(t){console.log(`websocket error: ${t}`),alert(`Server is starting up, please try again in a few seconds. ${t}`)},this.onGameList=()=>{}}setOnPeerMsg(t){this.onPeerMsg=t;for(let e of this.peers)e.onPeerMsg=t}setOnNewPeer(t){this.onNewPeer=t;for(let e of this.peers)e.onPeerReady=t}remoteFromId(t,e=!1){let s=this.peers.filter((e=>e.id==t));if(s.length>=1)return s[0];{if(e)throw"ID dosent exist";const s=t=>{this.wsSend("rtc-signal",t)};let i=new x(t,this.id,s,this.onPeerMsg,this.onNewPeer);return this.peers.push(i),console.log("new peer"),this.peers[this.peers.length-1]}}signalHandler(t){let e=this.remoteFromId(t.src);switch(console.log("handling signal"),t.messageType){case"data-offer":this.connected?this.hosting?e.handleDataOffer(t):console.log("someone tried to join us, not a host"):(this.hosting=!0,e.handleDataOffer(t)),this.connected=!0;break;case"data-answer":this.hosting=!1,this.connected=!0,console.log("it was a data answer"),e.handleDataAnswer(t);break;case"ice-candidate":console.log("it was a ice candidate"),e.handleIceCandidate(t);break;default:console.log("invalid signal recived")}}joinGame(t){if(this.peers=[],!this.id)return void console.log("tried to join a game before getting id");this.hosting=!1,this.visable=!1,this.remoteFromId(t).createDataOffer()}wsSend(t,e){this.socket.send(JSON.stringify({type:t,data:e}))}rtcSendString(t,e=-1){if(this.hosting&&-2===e)this.onPeerMsg(JSON.parse(t),this.id);else if(this.connected)if(-1===e||-2===e)for(let e of this.peers)e.sendString(t);else this.remoteFromId(e).sendString(t);else alert("tried to rtcSend before connected")}rtcSendObj(t,e=-1){this.rtcSendString(JSON.stringify(t),e)}getGames(t){this.wsSend("list-games"),this.onGameList=t}setVis(t){this.visable=t,this.wsSend("change-game",this.visable)}toggleVis(){return this.setVis(!this.visable),this.visable}isReady(){return this.peers.every((t=>t.ready))}};class f{constructor(){this.tickrate=30,this.tickNum=0,this.tickTimes=[],this.mapSeed=379491230,this.map=g(this.mapSeed),this.players=[],S.style.transform="translate(-50%, -200%)",m.setOnPeerMsg(((t,e)=>{switch(t.type){case"player-input":this.takePlayerInput(e,t);break;case"pong":this.takePing(e,t);break;default:console.log("host got something unknown")}})),m.setOnNewPeer((t=>{console.log("sending new client the map"),m.rtcSendObj({type:"world-data",data:this.mapSeed},t)})),setInterval((()=>{this.tick()}),1e3/this.tickrate),console.log("created game host"),this.createExplosion=t=>{console.log("called host create explosion");for(let e of this.players)e.impulseFrom(t,.05)}}tick(){this.tickNum+=1,this.tickTimes.push({num:this.tickNum,time:performance.now()})>=30&&this.tickTimes.shift();for(let t of this.players){const e=this.generateGameState(t.id);t.id!==m.id?m.rtcSendObj(e,t.id):b.onPeerMsg(e)}}phyTick(t){for(let e of this.players)e.update(t,this.map)}generateGameState(t=-1){return-1==t?{type:"game-state",data:this.players.map((t=>t.toData())),frame:this.tickNum}:{type:"game-state",data:this.players.filter((t=>!0)).map((t=>t.toData())),frame:this.tickNum}}takePing(t,e){const s=this.tickTimes.filter((t=>t.num==e.frame));if(s.length>=1)var i=s[0].time;else i=0;const n=performance.now();let o=this.players.filter((e=>e.id===t));1==o.length&&(o[0].ping=n-i)}takePlayerInput(t,e){let s=this.players.filter((e=>e.id===t));1==s.length?s[0].takeInput(e,this.map):s.length>1?console.log(`there were ${s.length} players with the same id (too many)`):(console.log("tried to set player data on player that doesnt exist, creating player"),this.players.push(u.newRandom(t,this.createExplosion)))}}p=i("cMFB8");class P{constructor(t,e){this.age=0,this.MAX_AGE=.3,this.alive=!0,this.pos=t,this.size=e}render(t){const e=this.pos.worldToPixel(t,p.canvas),s=this.age/this.MAX_AGE*this.size,i=this.pos.plus(new o(s,0)).worldToPixel(t,p.canvas),n=e.distanceTo(i);p.ctx.beginPath(),p.ctx.strokeStyle=`rgb(${r(255*this.age/this.MAX_AGE)}, 0, 50)`,p.ctx.lineWidth=3,p.ctx.arc(e.x,e.y,n,0,2*Math.PI),p.ctx.stroke()}update(t){this.age+=t,this.age>this.MAX_AGE&&(this.alive=!1)}}p=i("cMFB8");class b{constructor(){this.framerate=0,this.frametimes=[],this.players=[],this.map=[],this.viewPos=new h(0,0,999,.2),this.VIEW_MARGIN=.1,this.outerViewPos=new h(0,0,999,.3),this.clientTickRate=30,this.lastTickTime=0,this.inputX=0,this.inputY=0,this.lookAngle=0,this.closesHandle=new o(-1,-1),this.closesntHandleDist=99999,this.grabbing=!1,this.shooting=!1,this.detonating=!1,this.explosions=[],this.players=[],this.createExplosion=t=>{console.log("called create explosion");for(let e of k.players)e.impulseFrom(t,.04);k.explosions.push(new P(t,.04))}}static onPeerMsg(t){switch(t.type){case"world-data":const e=g(t.data);for(let t of e){let e={p1:new o(t.p1.x,t.p1.y),p2:new o(t.p2.x,t.p2.y)};k.map.some((t=>{}))||k.map.push(e)}console.log("set map");break;case"game-state":let s=k.players.map((t=>t.id));for(let e of t.data)if(-1!=s.indexOf(e.id)){const t=s.indexOf(e.id);k.players[t].networkUpdate(e)}else console.log(`created new player ${e.id}`),k.players.push(u.fromPlayerData(e,k.createExplosion)),s=k.players.map((t=>t.id));m.rtcSendObj({type:"pong",frame:t.frame})}}render(t){t.fillStyle="white",t.fillRect(0,0,p.canvas.width,p.canvas.height),t.fillStyle="red",t.arc(w.x,w.y,10,0,2*Math.PI),t.fill(),this.viewPos.w=this.viewPos.h*p.canvas.width/p.canvas.height,this.outerViewPos=new h(this.viewPos.x-this.VIEW_MARGIN/2,this.viewPos.y-this.VIEW_MARGIN/2,this.viewPos.w+this.VIEW_MARGIN,this.viewPos.h+this.VIEW_MARGIN),this.us=this.getOurPlayer(),this.players.length>=1&&(this.drawMap(),this.drawMinimap(),this.drawPlayers()),n(t,Math.round(100*this.framerate)/100+"fps",100,50,30)}drawMinimap(){let t={x:p.canvas.width-211,y:p.canvas.height-211,w:200,h:200};p.ctx.beginPath(),p.ctx.fillStyle="rgba(200, 200, 200, 0.8)",p.ctx.rect(t.x,t.y,t.w,t.h),p.ctx.fill(),p.ctx.strokeStyle="rgb(0, 0, 0, 0.9)",p.ctx.lineWidth=2;for(let e of this.map)p.ctx.beginPath(),p.ctx.moveTo(t.x+e.p1.x*t.w,t.y+e.p1.y*t.h),p.ctx.lineTo(t.x+e.p2.x*t.w,t.y+e.p2.y*t.h),p.ctx.stroke();p.ctx.beginPath(),p.ctx.fillStyle="rgba(200, 200, 200, 0.8)",p.ctx.rect(t.x+this.viewPos.x*t.w,t.y+this.viewPos.y*t.h,t.w*this.viewPos.w,t.h*this.viewPos.h),p.ctx.fill();for(let e of this.players)p.ctx.beginPath(),p.ctx.fillStyle="rgba(255, 0, 0, 1)",p.ctx.rect(t.x+e.pos.x*t.w,t.y+e.pos.y*t.h,10,10),p.ctx.fill();p.ctx.beginPath(),p.ctx.strokeStyle="#000",p.ctx.lineWidth=3,p.ctx.rect(t.x,t.y,t.w,t.h),p.ctx.stroke(),p.ctx.beginPath()}drawMap(){p.ctx.lineWidth=2,p.ctx.strokeStyle="#000",this.closesHandle=new o(-1,-1),this.closesntHandleDist=999;for(let t of this.map)if(t.p1.x>this.outerViewPos.x&&t.p1.x<this.outerViewPos.x+this.outerViewPos.w&&t.p1.y>this.outerViewPos.y&&t.p1.y<this.outerViewPos.y+this.outerViewPos.h||t.p2.x>this.outerViewPos.x&&t.p2.x<this.outerViewPos.x+this.outerViewPos.w&&t.p2.y>this.outerViewPos.y&&t.p2.y<this.outerViewPos.y+this.outerViewPos.h){const e=c(t);p.ctx.beginPath(),this.us&&(e.checkPos(this.us.pos)?p.ctx.fillStyle="rgba(100, 100, 100, 0.5)":p.ctx.fillStyle="rgba(255, 0, 0, 0.5)");const s=e.worldToPixel(this.viewPos,p.canvas);p.ctx.rect(s.x,s.y,s.w,s.h),p.ctx.fill(),p.ctx.beginPath();let i=t.p1.worldToPixel(this.viewPos,p.canvas);p.ctx.moveTo(i.x,i.y);let n=t.p2.worldToPixel(this.viewPos,p.canvas);if(p.ctx.lineTo(n.x,n.y),p.ctx.stroke(),this.us&&!this.us.swinging){const e=this.playerDist(t.p1,!0);e<this.closesntHandleDist&&!this.us.recentlySwung.some((e=>e.p.equals(t.p1)))&&(this.closesHandle=t.p1,this.closesntHandleDist=e);const s=this.playerDist(t.p2,!0);s<this.closesntHandleDist&&!this.us.recentlySwung.some((e=>e.p.equals(t.p2)))&&(this.closesHandle=t.p2,this.closesntHandleDist=s)}}for(let t of this.explosions)t.render(this.viewPos);if(this.us&&this.closesntHandleDist<998){p.ctx.beginPath(),p.ctx.strokeStyle="rgba(150, 150, 150, 0.8)",p.ctx.lineWidth=5;const t=this.getOurPlayer();if(t){let e=t.pos.worldToPixel(this.viewPos,p.canvas);p.ctx.moveTo(e.x,e.y);let s=this.closesHandle.worldToPixel(this.viewPos,p.canvas);p.ctx.lineTo(s.x,s.y),p.ctx.stroke(),p.ctx.beginPath(),p.ctx.arc(s.x,s.y,30,0,2*Math.PI),p.ctx.stroke()}}}drawPlayers(){for(let t of this.players)t.render(this.viewPos)}playerDist(t,e=!1){if(this.us){const s=this.us.pos;return e?(s.x-t.x)**2+(s.y-t.y)**2:Math.sqrt((s.x-t.x)**2+(s.y-t.y)**2)}return 999}getOurPlayer(){const t=this.players.filter((t=>t.id===m.id));if(!(t.length<1||t.length>1))return t[0]}update(t){const e=t/1e3;for(let e=0;e<this.players.length;e++)this.players[e].update(t,this.map);y.checkKey("KeyD")&&(this.inputX+=t),y.checkKey("KeyA")&&(this.inputX-=t),y.checkKey("KeyW")&&(this.inputY+=t),y.checkKey("KeyS")&&(this.inputY-=t),y.checkKey("Space")?this.grabbing=!0:this.grabbing=!1,w.hasClicked("left")&&(this.shooting=!0),this.detonating=w.right,this.lastTickTime+=t;const s=this.getOurPlayer();if(s){const t=new o(s.pos.x,s.pos.y);this.viewPos.setMid(t);const e=s.pos.worldToPixel(this.viewPos,p.canvas);this.lookAngle=e.angleTo(new o(w.x,w.y)),s.setLookAngle(this.lookAngle),s.takeInput(this.getInput(!1),this.map)}for(let t of this.explosions)t.update(e);this.explosions=this.explosions.filter((t=>t.alive)),this.frametimes.push(t),this.frametimes.length>10&&this.frametimes.shift(),this.framerate=1/(this.frametimes.reduce(((t,e)=>t+e))/(1e3*this.frametimes.length))}joinRandomGame(){let t=m.gamesList.filter((t=>t!=m.id));m.joinGame(t[0])}joinGame(t){m.gamesList.some((e=>e==t))?(m.joinGame(t),S.style.transform="translate(-50%, -200%)",setInterval((()=>{this.sendInput()}),1e3/this.clientTickRate),k.sendInput()):console.log("game dosent exist")}sendInput(){m.isReady()?m.rtcSendObj(this.getInput(),-2):(console.log("isnt ready"),console.log(m.peers,m.peers.map((t=>`${t.peerConnection.connectionState}  ${t.peerConnection.iceConnectionState}`))))}getInput(t=!0){const e={type:"player-input",data:{inputX:this.lastTickTime>0?r(this.inputX/this.lastTickTime,2):0,inputY:this.lastTickTime>0?r(this.inputY/this.lastTickTime,2):0,lookAngle:this.lookAngle}};return this.grabbing&&(e.data.swinging=!0),this.shooting&&(e.data.shooting=!0),this.detonating&&(e.data.detonating=!0),t&&(this.inputX=0,this.inputY=0,this.shooting=!1,this.lastTickTime=0),e}refreshGamesList(){m.getGames((t=>function(t,e){let s=document.querySelectorAll(".gameListItem");if(console.log(s),s)for(var i=0;i<s.length;i++){s[i].remove()}for(let s of t){let t=document.createElement("tr");t.classList.add("gameListItem");let i=document.createElement("td");if(s==e)var n=document.createTextNode("exampleName (you)");else n=document.createTextNode("exampleName");i.appendChild(n);let o=document.createElement("td"),h=document.createTextNode(s.toString());o.appendChild(h);let l=document.createElement("td"),a=document.createTextNode("exampleName");l.appendChild(a),t.appendChild(i),t.appendChild(o),t.appendChild(l),t.onclick=()=>{k.joinGame(s)},document.getElementById("gameList")?.appendChild(t)}}(t,m.id)))}isHosting(){return m.hosting}}const k=new b;let v;m.setOnPeerMsg(b.onPeerMsg);let S=document.getElementById("gameListOuter");document.getElementById("refreshButton").onclick=()=>{k.refreshGamesList()},document.getElementById("testButton").onclick=()=>{m.rtcSendString("this is working YAY!"),console.log("send data")};let T=document.getElementById("gameButton");T?T.onclick=()=>{let t=m.toggleVis();T.innerHTML=t?"toggle game visability [x]":"toggle game visability [ ]"}:console.log("game button didnt exist");const A=document.getElementById("connectingMsg");m.onServerOpen=()=>{A.style.display="none"};let M=performance.now();window.requestAnimationFrame((function t(e){let s=e-M;M=e,k.isHosting()?(v||(v=new f,k.map=v.map,setInterval((()=>{k.sendInput()}),1e3/k.clientTickRate)),v.phyTick(s),k.update(s),k.render(p.ctx)):m.isReady()&&k.players.length>=1&&(k.update(s),k.render(p.ctx)),window.requestAnimationFrame(t)}));
//# sourceMappingURL=index.bcc97d5c.js.map
